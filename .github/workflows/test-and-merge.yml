name: Test, Merge Protection and Deploy

on:
  pull_request:
    branches: [ main ]
  push:
    branches: [ main ]

jobs:
  # â”€â”€â”€ Stage 1: Run All Tests â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  test:
    runs-on: ubuntu-latest
    
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: test_user
          POSTGRES_PASSWORD: test_password
          POSTGRES_DB: test_lesone_db
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    env:
      DATABASE_URL: postgresql://test_user:test_password@localhost:5432/test_lesone_db
      ADMIN_EMAIL: admin@lesone.com
      ADMIN_PASSWORD: admin123
      JWT_SECRET: test-jwt-secret-for-github-actions
      JWT_EXPIRES_IN: 7d

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Use Node.js 25.2.1
      uses: actions/setup-node@v4
      with:
        node-version: 25.2.1
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Set up test environment
      run: |
        npm run db:generate
        npx prisma db push
        echo "Test environment configured"

    - name: Run Unit Tests
      run: npm run test:unit

    - name: Run Integration Tests
      run: npm run test:integration

    - name: Test Results Summary
      if: always()
      run: |
        if [ $? -eq 0 ]; then
          echo "âœ… All tests passed successfully!"
          echo "âœ… Unit tests: PASSED"
          echo "âœ… Integration tests: PASSED"
          echo "ğŸ‰ Ready to merge!"
        else
          echo "âŒ Tests failed!"
          echo "âŒ Merge blocked until tests pass"
          exit 1
        fi

  # â”€â”€â”€ Stage 2: Merge Protection (PRs only) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  merge-protection:
    runs-on: ubuntu-latest
    needs: [test]
    if: github.event_name == 'pull_request'
    
    steps:
    - name: Merge Protection Gate
      run: |
        echo "âœ… All tests passed - PR is ready to merge!"
        echo "âœ… Unit tests completed successfully"
        echo "âœ… Integration tests completed successfully" 
        echo "âœ… Test database connection verified"
        echo ""
        echo "ğŸ‰ Safe to merge to main branch!"

    - name: Comment on PR
      uses: actions/github-script@v7
      if: success()
      with:
        script: |
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: 'âœ… **All tests passed!** This PR is ready to merge.\n\n**Test Results:**\n- âœ… Unit Tests: PASSED\n- âœ… Integration Tests: PASSED\n- âœ… Test Database: CONNECTED\n\nğŸ‰ Safe to merge to main!'
          })

    - name: Failure Comment on PR
      uses: actions/github-script@v7
      if: failure()
      with:
        script: |
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: 'âŒ **Tests failed!** This PR cannot be merged.\n\n**Issues Found:**\n- âŒ One or more tests are failing\n- âŒ Check the Actions tab for detailed error logs\n\nğŸ”§ Please fix the failing tests before attempting to merge.'
          })

  # â”€â”€â”€ Stage 3: Deploy to Production (push to main only) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  deploy:
    runs-on: ubuntu-latest
    needs: [test]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'

    steps:
      - name: Deploy to Production Server
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          port: ${{ secrets.SERVER_PORT || 22 }}
          script: |
            set -e

            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            echo "ğŸš€ Starting Production Deployment"
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

            cd /root/enterpriseCamp

            # â”€â”€ Pull Latest Code â”€â”€
            echo "ğŸ“¥ Pulling latest changes from main..."
            git fetch origin main
            git reset --hard origin/main

            # â”€â”€ Backend Setup â”€â”€
            echo "ğŸ“¦ Installing backend dependencies..."
            npm ci --production

            echo "ğŸ”§ Generating Prisma client..."
            npx prisma generate

            echo "ğŸ—„ï¸ Running database migrations..."
            npx prisma db push --accept-data-loss=false

            # â”€â”€ Frontend Setup â”€â”€
            echo "ğŸ¨ Building frontend..."
            cd frontend
            npm ci
            npm run build
            cd ..

            # â”€â”€ Restart Services with PM2 â”€â”€
            echo "â™»ï¸ Restarting PM2 services..."
            if pm2 list | grep -q "backend\|frontend"; then
              pm2 reload ecosystem.config.js
            else
              pm2 start ecosystem.config.js
            fi
            pm2 save

            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            echo "âœ… Deployment completed successfully!"
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

      - name: Deployment Success Notification
        if: success()
        run: |
          echo "âœ… Production deployment completed!"
          echo "ğŸ“… Deployed at: $(date -u +'%Y-%m-%d %H:%M:%S UTC')"
          echo "ğŸ”— Commit: ${{ github.sha }}"

      - name: Deployment Failure Notification
        if: failure()
        run: |
          echo "âŒ Deployment FAILED!"
          echo "ğŸ” Check logs above for details"
          echo "ğŸ”— Failed commit: ${{ github.sha }}"
          exit 1