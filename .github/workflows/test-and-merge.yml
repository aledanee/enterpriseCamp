name: Test and Merge Protection

on:
  pull_request:
    branches: [ main ]
  push:
    branches: [ main ]

jobs:
  test:
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        node-version: [18.x, 20.x]

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Use Node.js ${{ matrix.node-version }}
      uses: actions/setup-node@v4
      with:
        node-version: ${{ matrix.node-version }}
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Run Unit Tests
      run: npm run test:unit

    - name: Run Integration Tests
      run: npm run test:integration


  lint:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Use Node.js 20.x
      uses: actions/setup-node@v4
      with:
        node-version: 20.x
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Check code formatting
      run: |
        if ! npm ls prettier &>/dev/null; then
          echo "Prettier not installed, skipping format check"
        else
          npm run format:check
        fi

    - name: Lint code
      run: |
        if ! npm ls eslint &>/dev/null; then
          echo "ESLint not installed, skipping lint check"
        else
          npm run lint
        fi

  security:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Use Node.js 20.x
      uses: actions/setup-node@v4
      with:
        node-version: 20.x
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Run security audit
      run: npm audit --audit-level=high

    - name: Check for vulnerabilities
      run: |
        if npm audit --audit-level=high --json | jq '.vulnerabilities | length' | grep -q '^0$'; then
          echo "No high-severity vulnerabilities found"
        else
          echo "High-severity vulnerabilities detected"
          npm audit --audit-level=high
          exit 1
        fi

  build:
    runs-on: ubuntu-latest
    needs: [test, lint, security]
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Use Node.js 20.x
      uses: actions/setup-node@v4
      with:
        node-version: 20.x
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Test application startup
      run: |
        # Set environment variables for testing
        export ADMIN_EMAIL=admin@lesone.com
        export ADMIN_PASSWORD=admin123
        export JWT_SECRET=test-jwt-secret-for-github-actions
        export JWT_EXPIRES_IN=7d
        export DATABASE_URL=postgresql://test:test@localhost:5432/test_db
        
        # Start the application in background
        timeout 30s npm start &
        APP_PID=$!
        
        # Wait for app to start
        sleep 10
        
        # Check if app is running
        if ps -p $APP_PID > /dev/null; then
          echo "Application started successfully"
          kill $APP_PID
        else
          echo "Application failed to start"
          exit 1
        fi

  database-test:
    runs-on: ubuntu-latest
    
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: test_user
          POSTGRES_PASSWORD: test_password
          POSTGRES_DB: test_lesone_db
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Use Node.js 20.x
      uses: actions/setup-node@v4
      with:
        node-version: 20.x
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Test database connection
      env:
        DATABASE_URL: postgresql://test_user:test_password@localhost:5432/test_lesone_db
        ADMIN_EMAIL: admin@lesone.com
        ADMIN_PASSWORD: admin123
        JWT_SECRET: test-jwt-secret
        JWT_EXPIRES_IN: 7d
      run: |
        # Generate Prisma client
        npm run db:generate
        
        # Test database connection with a simple health check
        node -e "
          const { PrismaClient } = require('@prisma/client');
          const prisma = new PrismaClient();
          
          async function testConnection() {
            try {
              await prisma.\$queryRaw\`SELECT 1\`;
              console.log('Database connection successful');
              await prisma.\$disconnect();
            } catch (error) {
              console.error('Database connection failed:', error);
              process.exit(1);
            }
          }
          
          testConnection();
        "

  merge-gate:
    runs-on: ubuntu-latest
    needs: [test, build, database-test]
    if: github.event_name == 'pull_request'
    
    steps:
    - name: All checks passed
      run: |
        echo "âœ… All tests and checks have passed!"
        echo "âœ… Unit tests: PASSED"
        echo "âœ… Integration tests: PASSED"
        echo "âœ… Security audit: PASSED"
        echo "âœ… Build test: PASSED"
        echo "âœ… Database connection: PASSED"
        echo ""
        echo "ðŸŽ‰ Pull request is ready to be merged!"

    - name: Comment on PR
      uses: actions/github-script@v7
      with:
        script: |
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: 'âœ… **All checks passed!** This PR is ready to merge.\n\n**Test Results:**\n- âœ… Unit Tests\n- âœ… Integration Tests\n- âœ… Security Audit\n- âœ… Build Test\n- âœ… Database Connection\n\nðŸŽ‰ Safe to merge!'
          })