name: Test and Merge Protection

on:
  pull_request:
    branches: [ main ]
  push:
    branches: [ main ]

jobs:
  test:
    runs-on: ubuntu-latest
    
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: test_user
          POSTGRES_PASSWORD: test_password
          POSTGRES_DB: test_lesone_db
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Use Node.js 25.2.1
      uses: actions/setup-node@v4
      with:
        node-version: 25.2.1
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Set up test environment
      env:
        DATABASE_URL: postgresql://test_user:test_password@localhost:5432/test_lesone_db
        ADMIN_EMAIL: admin@lesone.com
        ADMIN_PASSWORD: admin123
        JWT_SECRET: test-jwt-secret-for-github-actions
        JWT_EXPIRES_IN: 7d
      run: |
        # Generate Prisma client
        npm run db:generate
        echo "Test environment configured"

    - name: Run Unit Tests
      env:
        DATABASE_URL: postgresql://test_user:test_password@localhost:5432/test_lesone_db
        ADMIN_EMAIL: admin@lesone.com
        ADMIN_PASSWORD: admin123
        JWT_SECRET: test-jwt-secret-for-github-actions
        JWT_EXPIRES_IN: 7d
      run: npm run test:unit

    - name: Run Integration Tests
      env:
        DATABASE_URL: postgresql://test_user:test_password@localhost:5432/test_lesone_db
        ADMIN_EMAIL: admin@lesone.com
        ADMIN_PASSWORD: admin123
        JWT_SECRET: test-jwt-secret-for-github-actions
        JWT_EXPIRES_IN: 7d
      run: npm run test:integration

    - name: Test Results Summary
      if: always()
      run: |
        if [ $? -eq 0 ]; then
          echo "‚úÖ All tests passed successfully!"
          echo "‚úÖ Unit tests: PASSED"
          echo "‚úÖ Integration tests: PASSED"
          echo "üéâ Ready to merge!"
        else
          echo "‚ùå Tests failed!"
          echo "‚ùå Merge blocked until tests pass"
          exit 1
        fi

  merge-protection:
    runs-on: ubuntu-latest
    needs: [test]
    if: github.event_name == 'pull_request'
    
    steps:
    - name: Merge Protection Gate
      run: |
        echo "‚úÖ All tests passed - PR is ready to merge!"
        echo "‚úÖ Unit tests completed successfully"
        echo "‚úÖ Integration tests completed successfully" 
        echo "‚úÖ Test database connection verified"
        echo ""
        echo "üéâ Safe to merge to main branch!"

    - name: Comment on PR
      uses: actions/github-script@v7
      if: success()
      with:
        script: |
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: '‚úÖ **All tests passed!** This PR is ready to merge.\n\n**Test Results:**\n- ‚úÖ Unit Tests: PASSED\n- ‚úÖ Integration Tests: PASSED\n- ‚úÖ Test Database: CONNECTED\n\nüéâ Safe to merge to main!'
          })

    - name: Failure Comment on PR
      uses: actions/github-script@v7
      if: failure()
      with:
        script: |
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: '‚ùå **Tests failed!** This PR cannot be merged.\n\n**Issues Found:**\n- ‚ùå One or more tests are failing\n- ‚ùå Check the Actions tab for detailed error logs\n\nüîß Please fix the failing tests before attempting to merge.'
          })